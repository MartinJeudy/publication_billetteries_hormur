<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hormur - Automatisation des Publications</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .platform-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .platform-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
            animation: pulse 2s infinite;
        }

        .status-indicator.active {
            background: #4CAF50;
        }

        .status-indicator.processing {
            background: #FFC107;
        }

        .status-indicator.error {
            background: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #999;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .webhook-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .webhook-url {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            border: 2px dashed #ddd;
        }

        .copy-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .copy-button:hover {
            background: #5a67d8;
        }

        .logs-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .logs-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-left: 3px solid #666;
        }

        .log-entry.success {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .log-entry.error {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .log-entry.info {
            border-left-color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        .test-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .test-form {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .test-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
        }

        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .test-button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ­ Hormur Automation Hub</h1>
            <p>SystÃ¨me de publication automatique multi-plateformes</p>
        </div>

        <div class="webhook-panel">
            <h2>ðŸ“¡ Webhook Endpoint</h2>
            <p>URL Ã  configurer dans Make pour recevoir les Ã©vÃ©nements :</p>
            <div class="webhook-url" id="webhookUrl">
                https://your-domain.netlify.app/api/publish-event
            </div>
            <button class="copy-button" onclick="copyWebhookUrl()">ðŸ“‹ Copier l'URL</button>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <div class="platform-header">
                    <span class="platform-name">Eventim Light</span>
                    <span class="status-indicator" id="eventim-status"></span>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="eventim-success">0</div>
                        <div class="stat-label">PubliÃ©s</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="eventim-queue">0</div>
                        <div class="stat-label">En attente</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="eventim-errors">0</div>
                        <div class="stat-label">Erreurs</div>
                    </div>
                </div>
            </div>

            <div class="status-card">
                <div class="platform-header">
                    <span class="platform-name">JDS</span>
                    <span class="status-indicator" id="jds-status"></span>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="jds-success">0</div>
                        <div class="stat-label">PubliÃ©s</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="jds-queue">0</div>
                        <div class="stat-label">En attente</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="jds-errors">0</div>
                        <div class="stat-label">Erreurs</div>
                    </div>
                </div>
            </div>

            <div class="status-card">
                <div class="platform-header">
                    <span class="platform-name">AllEvents</span>
                    <span class="status-indicator" id="allevents-status"></span>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="allevents-success">0</div>
                        <div class="stat-label">PubliÃ©s</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="allevents-queue">0</div>
                        <div class="stat-label">En attente</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="allevents-errors">0</div>
                        <div class="stat-label">Erreurs</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-panel">
            <h2>ðŸ§ª Test de Publication</h2>
            <p>Testez la publication avec un Ã©vÃ©nement exemple :</p>
            <div class="test-form">
                <input type="text" class="test-input" id="testEventName" placeholder="Nom de l'Ã©vÃ©nement" value="Concert Test - Ne pas rÃ©server">
                <button class="test-button" onclick="sendTestEvent()">Envoyer un test</button>
            </div>
        </div>

        <div class="logs-panel">
            <h2>ðŸ“Š Logs en temps rÃ©el</h2>
            <div class="logs-container" id="logsContainer">
                <div class="log-entry info">[INFO] SystÃ¨me initialisÃ© et prÃªt</div>
                <div class="log-entry info">[INFO] En attente de webhooks depuis Make...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration WebSocket pour logs temps rÃ©el
        let ws;
        const stats = {
            eventim: { success: 0, queue: 0, errors: 0 },
            jds: { success: 0, queue: 0, errors: 0 },
            allevents: { success: 0, queue: 0, errors: 0 }
        };

        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleUpdate(data);
            };

            ws.onerror = () => {
                addLog('error', 'Connexion WebSocket perdue, reconnexion...');
                setTimeout(initWebSocket, 3000);
            };
        }

        function handleUpdate(data) {
            if (data.type === 'log') {
                addLog(data.level, data.message);
            } else if (data.type === 'stats') {
                updateStats(data.platform, data.stats);
            } else if (data.type === 'status') {
                updateStatus(data.platform, data.status);
            }
        }

        function addLog(level, message) {
            const logsContainer = document.getElementById('logsContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${level}`;
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // Limiter Ã  100 logs
            while (logsContainer.children.length > 100) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }

        function updateStats(platform, newStats) {
            stats[platform] = newStats;
            document.getElementById(`${platform}-success`).textContent = newStats.success;
            document.getElementById(`${platform}-queue`).textContent = newStats.queue;
            document.getElementById(`${platform}-errors`).textContent = newStats.errors;
        }

        function updateStatus(platform, status) {
            const indicator = document.getElementById(`${platform}-status`);
            indicator.className = `status-indicator ${status}`;
        }

        function copyWebhookUrl() {
            const url = document.getElementById('webhookUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                addLog('success', 'URL du webhook copiÃ©e dans le presse-papier');
            });
        }

        async function sendTestEvent() {
            const eventName = document.getElementById('testEventName').value;
            
            if (!eventName) {
                addLog('error', 'Veuillez entrer un nom d\'Ã©vÃ©nement');
                return;
            }

            const testData = {
                title: eventName,
                description: "Ceci est un Ã©vÃ©nement de test. Les rÃ©servations officielles sont sur Hormur.com",
                date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // Dans 30 jours
                time: "20:00",
                venue: "Lieu de test - Paris",
                address: "123 Rue de Test, 75001 Paris",
                imageUrl: "https://static.hormur.com/test/image.webp",
                eventUrl: "https://hormur.com/event/test",
                category: "Concert",
                price: "Gratuit - RÃ©servation officielle sur Hormur.com"
            };

            try {
                addLog('info', `Envoi de l'Ã©vÃ©nement test: ${eventName}`);
                
                const response = await fetch('/api/publish-event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    addLog('success', `Ã‰vÃ©nement test envoyÃ© avec succÃ¨s: ${result.message}`);
                } else {
                    addLog('error', `Erreur lors de l'envoi: ${result.error}`);
                }
            } catch (error) {
                addLog('error', `Erreur de connexion: ${error.message}`);
            }
        }

        // Mise Ã  jour de l'URL du webhook avec le domaine actuel
        document.addEventListener('DOMContentLoaded', () => {
            const webhookUrl = document.getElementById('webhookUrl');
            webhookUrl.textContent = `${window.location.origin}/api/publish-event`;
            
            // Initialiser WebSocket
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                initWebSocket();
            }
            
            addLog('info', 'Interface de monitoring chargÃ©e');
        });

        // Simulation de mises Ã  jour pour la dÃ©mo
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            setInterval(() => {
                const platforms = ['eventim', 'jds', 'allevents'];
                const platform = platforms[Math.floor(Math.random() * platforms.length)];
                const actions = ['success', 'processing', 'active'];
                const action = actions[Math.floor(Math.random() * actions.length)];
                
                if (action === 'success') {
                    stats[platform].success++;
                    updateStats(platform, stats[platform]);
                    addLog('success', `[${platform.toUpperCase()}] Ã‰vÃ©nement publiÃ© avec succÃ¨s`);
                }
                
                updateStatus(platform, action);
            }, 5000);
        }
    </script>
</body>
</html>
